# v0.7.0 Improvements Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix bugs, modernise the plugin to NetBox 4.3+ standards, improve the calendar view, and implement high-value feature requests from open issues.

**Architecture:** The plugin follows standard NetBox plugin conventions (models/views/forms/tables/filtersets/serializers/templates). Changes are organised into phases: bug fixes first, then standards compliance, then new features. Each phase results in a working, committable state. A new migration (0008) will bundle all model/schema changes.

**Tech Stack:** Python 3.10+, Django 5.x (via NetBox 4.4), DRF, NetBox plugin API, htmx (bundled with NetBox), nh3 (HTML sanitiser), icalendar (ICS generation)

---

## Phase 1: Bug Fixes & Trivials

### Task 1: Fix critical bugs in models.py

**Files:**
- Modify: `netbox_circuitmaintenance/models.py`

**Step 1: Fix color typo (line 32)**

Change `'orage'` to `'orange'` in `CircuitMaintenanceImpactTypeChoices.CHOICES`:

```python
# Before:
('DEGRADED', 'Degraded', 'orage'),
# After:
('DEGRADED', 'Degraded', 'orange'),
```

**Step 2: Fix verbose_name typo (line 128)**

```python
# Before:
verbose_name_plural = 'Circuit Maintenance Imapct'
# After:
verbose_name_plural = 'Circuit Maintenance Impact'
```

**Step 3: Fix comment typos (lines 9, 25)**

```python
# Before (line 9):
# Valid maintenance staus choices.
# After:
# Valid maintenance status choices.

# Before (line 25):
# Valid maintenance staus choices.
# After:
# Valid maintenance status choices.
```

**Step 4: Remove invalid max_length from DateTimeFields (lines 61, 66)**

```python
# Before:
start = models.DateTimeField(
    max_length=100,
    help_text='Start date and time of the maintenance event e.g. 2022-12-25 14:30'
)
end = models.DateTimeField(
    max_length=100,
    help_text='End date and time of the maintenance event e.g. 2022-12-26 14:30'
)

# After:
start = models.DateTimeField(
    help_text='Start date and time of the maintenance event e.g. 2022-12-25 14:30'
)
end = models.DateTimeField(
    help_text='End date and time of the maintenance event e.g. 2022-12-26 14:30'
)
```

**Step 5: Fix BooleanField null=True (line 77-83)**

```python
# Before:
acknowledged = models.BooleanField(
    default=False,
    null=True,
    blank=True,
    verbose_name="Acknowledged?",
    help_text="Confirm if this maintenance event has been acknowledged"
)
# After:
acknowledged = models.BooleanField(
    default=False,
    verbose_name="Acknowledged?",
    help_text="Confirm if this maintenance event has been acknowledged"
)
```

**Step 6: Run linting**

Run: `cd /Users/jason.yates79/Documents/GitHub/netbox-circuitmaintenance && make format && make lint`

**Step 7: Commit**

```bash
git add netbox_circuitmaintenance/models.py
git commit -m "fix: correct typos, remove invalid field params in models"
```

---

### Task 2: Fix summary column broken HTML in tables.py

**Files:**
- Modify: `netbox_circuitmaintenance/tables.py:20`

**Step 1: Fix the TemplateColumn**

The current template string is malformed HTML and uses Bootstrap 4 attributes. Replace with a proper column:

```python
# Before:
summary = tables.TemplateColumn('<data-toggle="tooltip" title="{{record.summary}}">{{record.summary|truncatewords:15}}')

# After:
summary = tables.TemplateColumn(
    '<span data-bs-toggle="tooltip" title="{{ record.summary }}">{{ record.summary|truncatewords:15 }}</span>'
)
```

**Step 2: Run linting**

Run: `make format && make lint`

**Step 3: Commit**

```bash
git add netbox_circuitmaintenance/tables.py
git commit -m "fix: correct malformed HTML and Bootstrap 5 attributes in summary column"
```

---

### Task 3: Fix broken FilterSet search on FK

**Files:**
- Modify: `netbox_circuitmaintenance/filtersets.py:24-29`

**Step 1: Fix the circuit FK lookup**

```python
# Before (line 27-28):
return queryset.filter(
    Q(circuit__icontains=value)
)

# After:
return queryset.filter(
    Q(circuit__cid__icontains=value)
)
```

**Step 2: Commit**

```bash
git add netbox_circuitmaintenance/filtersets.py
git commit -m "fix: correct FK lookup in CircuitMaintenanceImpactFilterSet search"
```

---

### Task 4: Fix XSS vulnerability in notification template

**Files:**
- Modify: `pyproject.toml` (add nh3 dependency)
- Modify: `netbox_circuitmaintenance/templatetags/` (new directory + file)
- Modify: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/circuitmaintenancenotifications.html`

**Step 1: Add nh3 as a dependency**

In `pyproject.toml`, add a `dependencies` list under `[project]`:

```toml
[project]
# ... existing fields ...
dependencies = [
    "nh3>=0.2.14",
]
```

**Step 2: Create a template filter for sanitisation**

Create directory and file `netbox_circuitmaintenance/templatetags/__init__.py` (empty) and `netbox_circuitmaintenance/templatetags/maintenance_filters.py`:

```python
import nh3
from django import template

register = template.Library()

ALLOWED_TAGS = {
    "a", "b", "br", "div", "em", "h1", "h2", "h3", "h4", "h5", "h6",
    "hr", "i", "li", "ol", "p", "pre", "span", "strong", "table",
    "tbody", "td", "th", "thead", "tr", "u", "ul",
}

ALLOWED_ATTRIBUTES = {
    "*": {"class", "style"},
    "a": {"href", "title", "target"},
    "td": {"colspan", "rowspan"},
    "th": {"colspan", "rowspan", "scope"},
}


@register.filter(name="sanitize_html")
def sanitize_html(value):
    """Sanitize HTML content, allowing safe formatting tags only."""
    if not value:
        return ""
    return nh3.clean(
        value,
        tags=ALLOWED_TAGS,
        attributes=ALLOWED_ATTRIBUTES,
        link_rel="noopener noreferrer nofollow",
    )
```

**Step 3: Update the notification template**

Replace the entire content of `circuitmaintenancenotifications.html`:

```html
{% extends 'generic/object.html' %}
{% load maintenance_filters %}

{% block content %}
<div class="card">
    <h5 class="card-header">Notification Email</h5>
    <div class="card-body">
        <table class="table table-hover attr-table">
            <tr>
                <th scope="row">Subject</th>
                <td>{{ object.subject }}</td>
            </tr>
            <tr>
                <th scope="row">From</th>
                <td>{{ object.email_from }}</td>
            </tr>
            <tr>
                <th scope="row">Received</th>
                <td>{{ object.email_recieved }}</td>
            </tr>
            <tr>
                <th scope="row">Maintenance</th>
                <td><a href="{{ object.circuitmaintenance.get_absolute_url }}">{{ object.circuitmaintenance }}</a></td>
            </tr>
        </table>
    </div>
</div>
<div class="card mt-3">
    <h5 class="card-header">Email Body</h5>
    <div class="card-body">
        {{ object.email_body|sanitize_html }}
    </div>
</div>
{% endblock content %}
```

**Step 4: Run linting**

Run: `make format && make lint`

**Step 5: Commit**

```bash
git add pyproject.toml
git add netbox_circuitmaintenance/templatetags/__init__.py
git add netbox_circuitmaintenance/templatetags/maintenance_filters.py
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/circuitmaintenancenotifications.html
git commit -m "fix: sanitize notification email HTML to prevent XSS"
```

---

### Task 5: Fix calendar navigation bugs

**Files:**
- Modify: `netbox_circuitmaintenance/views.py:85-166`

**Step 1: Fix prev_year/next_year and month query**

Replace the four navigation methods (lines 85-111) and the `formatmonth` query (line 152):

```python
def prev_month(self, month):
    if month == 1:
        return 12
    return month - 1

def next_month(self, month):
    if month == 12:
        return 1
    return month + 1

def prev_year(self, month, year):
    if month == 1:
        return year - 1
    return year

def next_year(self, month, year):
    if month == 12:
        return year + 1
    return year
```

**Step 2: Fix the month query in formatmonth (line 152)**

Replace the month-only query with a proper date range:

```python
def formatmonth(self, theyear, themonth):
    import calendar as cal_module
    _, last_day = cal_module.monthrange(theyear, themonth)
    month_start = datetime.date(theyear, themonth, 1)
    month_end = datetime.date(theyear, themonth, last_day)
    events = models.CircuitMaintenance.objects.filter(
        start__date__lte=month_end,
        end__date__gte=month_start,
    ).annotate(impact_count=Count('impact'))
    # ... rest unchanged
```

Also fix `formatday` (line 117) to handle multi-day events correctly. Replace the day filter:

```python
def formatday(self, day, weekday, events):
    """
    Return a day as a table cell.
    """
    if day == 0:
        return '<td>&nbsp;</td>'

    this_date = datetime.date(self.year, self.month, day)
    events_from_day = events.filter(
        start__date__lte=this_date,
        end__date__gte=this_date,
    )
    events_html = "<ul>"
    for event in events_from_day:
        if events_html != '<ul>':
            events_html += '<br><br>'

        # Format time of the event
        if event.start.date() == event.end.date():
            event_time = f'{event.start.strftime("%H:%M")} - {event.end.strftime("%H:%M")}'
        else:
            event_time = (
                f'{self.custom_strftime("SU %H:%M", event.start)} - '
                f'{self.custom_strftime("SU %H:%M", event.end)}'
            )

        events_html += (
            f'<span class="badge text-bg-{event.get_status_color()}">'
            f'<a href="{event.get_absolute_url()}">'
            f'{event_time}<br>{event.name}<br>'
            f'{event.provider} - {event.status}<br>'
            f'{event.impact_count} Impacted</a></span>'
        )
    events_html += "</ul>"

    today = datetime.date.today()
    css_class = self.cssclasses[weekday]
    if this_date == today:
        css_class += " today-highlight"

    return f'<td class="{css_class}"><strong>{day}</strong>{events_html}</td>'
```

**Step 3: Fix calendar URL navigation — use Django's {% url %} instead of basepath**

Update `calendar.html` navigation links to use `{% url %}` instead of `settings.BASE_PATH`:

```html
{% block controls %}
  <div class="controls">
    <div class="control-group">
        <a class="btn btn-outline-secondary" href="{% url 'plugins:netbox_circuitmaintenance:maintenanceschedule' %}?month={{ prev_month }}&year={{ prev_year }}">
            <i class="mdi mdi-arrow-left"></i> Previous Month
        </a>
        {% if month != this_month or year != this_year %}
        <a class="btn btn-outline-secondary" href="{% url 'plugins:netbox_circuitmaintenance:maintenanceschedule' %}?month={{ this_month }}&year={{ this_year }}">
            Today
        </a>
        {% endif %}
        <a class="btn btn-outline-secondary" href="{% url 'plugins:netbox_circuitmaintenance:maintenanceschedule' %}?month={{ next_month }}&year={{ next_year }}">
            Next Month <i class="mdi mdi-arrow-right"></i>
        </a>
    </div>
  </div>
{% endblock controls %}
```

Remove the `basepath` context variable from `views.py:205` (the `settings.BASE_PATH` line) and the `from django.conf import settings` import (line 12).

**Step 4: Run linting**

Run: `make format && make lint`

**Step 5: Commit**

```bash
git add netbox_circuitmaintenance/views.py
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar.html
git commit -m "fix: calendar year navigation, month boundary queries, and URL generation"
```

---

## Phase 2: NetBox 4.3+ Standards & Code Quality

### Task 6: Add constants and model improvements

**Files:**
- Create: `netbox_circuitmaintenance/constants.py`
- Modify: `netbox_circuitmaintenance/models.py`

**Step 1: Create constants.py**

```python
# Statuses that represent active/upcoming maintenance (not terminal states)
ACTIVE_STATUSES = (
    'TENTATIVE',
    'CONFIRMED',
    'IN-PROCESS',
    'RE-SCHEDULED',
    'UNKNOWN',
)
```

**Step 2: Add clone_fields, date validation, and unique constraint to models.py**

Add to `CircuitMaintenance` class (after the `comments` field, before `class Meta`):

```python
clone_fields = (
    'status', 'provider', 'acknowledged',
)
```

Add a `clean()` method to `CircuitMaintenance`:

```python
def clean(self):
    super().clean()
    if self.start and self.end and self.end <= self.start:
        raise ValidationError({
            'end': 'End date/time must be after start date/time.'
        })
```

Add `UniqueConstraint` to `CircuitMaintenanceImpact.Meta`:

```python
class Meta:
    ordering = ('impact',)
    verbose_name = 'Circuit Maintenance Impact'
    verbose_name_plural = 'Circuit Maintenance Impact'
    constraints = [
        models.UniqueConstraint(
            fields=['circuitmaintenance', 'circuit'],
            name='unique_maintenance_circuit',
        )
    ]
```

**Step 3: Update template_content.py and widgets.py to use ACTIVE_STATUSES**

In `template_content.py`, add import and replace all 3 hardcoded lists:

```python
from .constants import ACTIVE_STATUSES
```

Replace each `status__in=['TENTATIVE', 'CONFIRMED', 'IN-PROCESS', 'RE-SCHEDULED', 'UNKNOWN']` with `status__in=ACTIVE_STATUSES`.

In `widgets.py`, same change:

```python
from .constants import ACTIVE_STATUSES
```

Replace `status__in=['TENTATIVE', ...]` with `status__in=ACTIVE_STATUSES`.

**Step 4: Run linting**

Run: `make format && make lint`

**Step 5: Commit**

```bash
git add netbox_circuitmaintenance/constants.py
git add netbox_circuitmaintenance/models.py
git add netbox_circuitmaintenance/template_content.py
git add netbox_circuitmaintenance/widgets.py
git commit -m "feat: add constants, clone_fields, date validation, unique constraint"
```

---

### Task 7: Rename email_recieved to email_received

**Files:**
- Modify: `netbox_circuitmaintenance/models.py`
- Modify: `netbox_circuitmaintenance/forms.py`
- Modify: `netbox_circuitmaintenance/filtersets.py`
- Modify: `netbox_circuitmaintenance/api/serializers.py`
- Modify: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/circuitmaintenance.html:129,137,152`

**Step 1: Rename field in models.py (line 169)**

```python
# Before:
email_recieved = models.DateTimeField(
    verbose_name="Email Recieved"
)
# After:
email_received = models.DateTimeField(
    verbose_name="Email Received"
)
```

Also update Meta ordering (currently line 174):

```python
ordering = ('email_received',)
```

**Step 2: Update forms.py (lines 79, 81)**

```python
# In CircuitMaintenanceNotificationsForm.Meta:
fields = ('circuitmaintenance', 'subject', 'email_from', 'email_body', 'email_received')
widgets = {
    'email_received': DateTimePicker()
}
```

**Step 3: Update filtersets.py (line 35)**

```python
fields = ('id', 'email_body', 'subject', 'email_from', 'email_received')
```

**Step 4: Update api/serializers.py (lines 43, 90)**

```python
# NestedCircuitMaintenanceNotificationsSerializer (line 43):
fields = (
    'id', 'url', 'subject', 'email_from', 'email_received', 'created', 'last_updated',
)

# CircuitMaintenanceNotificationsSerializer (line 90):
fields = (
    'id', 'url', 'circuitmaintenance', 'email_body', 'subject', 'email_from', 'email_received', 'created', 'last_updated',
)
```

**Step 5: Update templates**

In `circuitmaintenance.html`:
- Line 122: `Recieved Maintenance Notifications` → `Received Maintenance Notifications`
- Line 129: `Date Recieved` → `Date Received`
- Line 137: `email.email_recieved` → `email.email_received`
- Line 152: `No maintenance notifications have been recieved` → `No maintenance notifications have been received`

In `circuitmaintenancenotifications.html` (already rewritten in Task 4, ensure it uses `email_received`).

**Step 6: Run linting**

Run: `make format && make lint`

**Step 7: Commit**

```bash
git add netbox_circuitmaintenance/models.py
git add netbox_circuitmaintenance/forms.py
git add netbox_circuitmaintenance/filtersets.py
git add netbox_circuitmaintenance/api/serializers.py
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/circuitmaintenance.html
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/circuitmaintenancenotifications.html
git commit -m "refactor: rename email_recieved to email_received (breaking: API field name change)"
```

---

### Task 8: Create migration for all model changes

**Files:**
- Create: `netbox_circuitmaintenance/migrations/0008_v070_improvements.py`

**Step 1: Write the migration**

This migration bundles: verbose_name fix, BooleanField null removal, UniqueConstraint, and field rename.

```python
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        (
            "netbox_circuitmaintenance",
            "0007_alter_circuitmaintenancenotifications_options_and_more",
        ),
    ]

    operations = [
        # Fix verbose_name_plural typo
        migrations.AlterModelOptions(
            name="circuitmaintenanceimpact",
            options={
                "ordering": ("impact",),
                "verbose_name": "Circuit Maintenance Impact",
                "verbose_name_plural": "Circuit Maintenance Impact",
            },
        ),
        # Remove null=True from acknowledged BooleanField
        migrations.AlterField(
            model_name="circuitmaintenance",
            name="acknowledged",
            field=models.BooleanField(
                default=False,
                help_text="Confirm if this maintenance event has been acknowledged",
                verbose_name="Acknowledged?",
            ),
        ),
        # Remove max_length from DateTimeFields
        migrations.AlterField(
            model_name="circuitmaintenance",
            name="start",
            field=models.DateTimeField(
                help_text="Start date and time of the maintenance event e.g. 2022-12-25 14:30",
            ),
        ),
        migrations.AlterField(
            model_name="circuitmaintenance",
            name="end",
            field=models.DateTimeField(
                help_text="End date and time of the maintenance event e.g. 2022-12-26 14:30",
            ),
        ),
        # Add unique constraint for circuit + maintenance
        migrations.AddConstraint(
            model_name="circuitmaintenanceimpact",
            constraint=models.UniqueConstraint(
                fields=["circuitmaintenance", "circuit"],
                name="unique_maintenance_circuit",
            ),
        ),
        # Rename email_recieved to email_received
        migrations.RenameField(
            model_name="circuitmaintenancenotifications",
            old_name="email_recieved",
            new_name="email_received",
        ),
        # Update ordering to use renamed field
        migrations.AlterModelOptions(
            name="circuitmaintenancenotifications",
            options={
                "ordering": ("email_received",),
                "verbose_name": "Circuit Maintenance Notification",
                "verbose_name_plural": "Circuit Maintenance Notification",
            },
        ),
    ]
```

**Step 2: Commit**

```bash
git add netbox_circuitmaintenance/migrations/0008_v070_improvements.py
git commit -m "migrate: add migration for v0.7.0 model changes"
```

---

### Task 9: Refactor serializers to NetBox 4.3+ pattern

**Files:**
- Modify: `netbox_circuitmaintenance/api/serializers.py`

**Step 1: Rewrite serializers.py**

Remove the three `WritableNestedSerializer` subclasses. Add `brief_fields` to each serializer. Use `nested=True` on FK fields.

```python
from rest_framework import serializers

from netbox.api.serializers import NetBoxModelSerializer
from ..models import (
    CircuitMaintenance,
    CircuitMaintenanceImpact,
    CircuitMaintenanceNotifications,
)
from circuits.api.serializers import CircuitSerializer, ProviderSerializer


class CircuitMaintenanceSerializer(NetBoxModelSerializer):
    url = serializers.HyperlinkedIdentityField(
        view_name='plugins-api:netbox_circuitmaintenance-api:circuitmaintenance-detail'
    )
    provider = ProviderSerializer(nested=True)

    class Meta:
        model = CircuitMaintenance
        fields = (
            'id', 'url', 'display', 'name', 'summary', 'status', 'provider',
            'start', 'end', 'internal_ticket', 'acknowledged', 'comments',
            'tags', 'custom_fields', 'created', 'last_updated',
        )
        brief_fields = ('id', 'url', 'display', 'name', 'status', 'provider', 'start', 'end')


class CircuitMaintenanceImpactSerializer(NetBoxModelSerializer):
    url = serializers.HyperlinkedIdentityField(
        view_name='plugins-api:netbox_circuitmaintenance-api:circuitmaintenanceimpact-detail'
    )
    circuit = CircuitSerializer(nested=True)
    circuitmaintenance = CircuitMaintenanceSerializer(nested=True)

    class Meta:
        model = CircuitMaintenanceImpact
        fields = (
            'id', 'url', 'display', 'circuitmaintenance', 'circuit', 'impact',
            'custom_fields', 'created', 'last_updated',
        )
        brief_fields = ('id', 'url', 'display', 'circuit', 'impact')


class CircuitMaintenanceNotificationsSerializer(NetBoxModelSerializer):
    url = serializers.HyperlinkedIdentityField(
        view_name='plugins-api:netbox_circuitmaintenance-api:circuitmaintenancenotifications-detail'
    )
    circuitmaintenance = CircuitMaintenanceSerializer(nested=True)

    class Meta:
        model = CircuitMaintenanceNotifications
        fields = (
            'id', 'url', 'display', 'circuitmaintenance', 'email_body',
            'subject', 'email_from', 'email_received', 'created', 'last_updated',
        )
        brief_fields = ('id', 'url', 'display', 'subject', 'email_from', 'email_received')
```

**Step 2: Update API views to remove nested serializer references**

In `netbox_circuitmaintenance/api/views.py`, update the import. The current imports reference the old nested serializers. Verify the import line reads:

```python
from .serializers import (
    CircuitMaintenanceSerializer,
    CircuitMaintenanceImpactSerializer,
    CircuitMaintenanceNotificationsSerializer,
)
```

The ViewSets themselves should be fine since they reference the main serializer classes.

**Step 3: Update the main CircuitMaintenanceView to provide impact/notification data via the serializer**

In `netbox_circuitmaintenance/api/views.py`, verify the CircuitMaintenanceViewSet. Since we removed the nested impact/notification fields from the main serializer (they were using the old nested pattern), we need the detail view to still expose related objects. The REST API detail for a maintenance record should rely on the separate impact/notification endpoints with filtering by `circuitmaintenance` ID. This is the standard NetBox pattern — related objects are queried separately.

**Step 4: Run linting**

Run: `make format && make lint`

**Step 5: Commit**

```bash
git add netbox_circuitmaintenance/api/serializers.py
git add netbox_circuitmaintenance/api/views.py
git commit -m "refactor: modernise serializers to NetBox 4.3+ brief_fields pattern"
```

---

### Task 10: Improve filtersets with TagFilter and better search

**Files:**
- Modify: `netbox_circuitmaintenance/filtersets.py`

**Step 1: Rewrite filtersets.py**

```python
from django.db.models import Q
from netbox.filtersets import NetBoxModelFilterSet
from .models import (
    CircuitMaintenance,
    CircuitMaintenanceImpact,
    CircuitMaintenanceNotifications,
)


class CircuitMaintenanceFilterSet(NetBoxModelFilterSet):

    class Meta:
        model = CircuitMaintenance
        fields = (
            'id', 'name', 'summary', 'status', 'provider', 'start', 'end',
            'internal_ticket', 'acknowledged',
        )

    def search(self, queryset, name, value):
        if not value.strip():
            return queryset
        return queryset.filter(
            Q(name__icontains=value)
            | Q(summary__icontains=value)
            | Q(provider__name__icontains=value)
            | Q(internal_ticket__icontains=value)
        )


class CircuitMaintenanceImpactFilterSet(NetBoxModelFilterSet):

    class Meta:
        model = CircuitMaintenanceImpact
        fields = ('id', 'circuitmaintenance', 'circuit', 'impact')

    def search(self, queryset, name, value):
        if not value.strip():
            return queryset
        return queryset.filter(
            Q(circuit__cid__icontains=value)
            | Q(circuitmaintenance__name__icontains=value)
        )


class CircuitMaintenanceNotificationsFilterSet(NetBoxModelFilterSet):

    class Meta:
        model = CircuitMaintenanceNotifications
        fields = ('id', 'email_body', 'subject', 'email_from', 'email_received')

    def search(self, queryset, name, value):
        if not value.strip():
            return queryset
        return queryset.filter(
            Q(subject__icontains=value)
            | Q(email_from__icontains=value)
        )
```

Note: `NetBoxModelFilterSet` in NetBox 4.x already includes `TagFilter` automatically for models that inherit from `NetBoxModel`. We removed `'impact'` and `'comments'` from CircuitMaintenance fields because `impact` is a reverse relation (not a filterable field) and `comments` is a text blob.

**Step 2: Fix filter form date fields in forms.py (lines 43-49)**

Replace the plain CharFields with DateTimeFields using DateTimePicker widgets:

```python
# Before:
start = forms.CharField(
    required=False
)
end = forms.CharField(
    required=False
)

# After:
start = forms.DateTimeField(
    required=False,
    widget=DateTimePicker()
)
end = forms.DateTimeField(
    required=False,
    widget=DateTimePicker()
)
```

Also remove the stale `impact` field from the filter form (lines 59-62) since it doesn't map to a real filter:

```python
# Remove this:
impact = forms.ModelMultipleChoiceField(
    queryset=CircuitMaintenanceImpact.objects.all(),
    required=False
)
```

And remove `CircuitMaintenanceImpact` from the forms.py import if no longer used.

**Step 3: Run linting**

Run: `make format && make lint`

**Step 4: Commit**

```bash
git add netbox_circuitmaintenance/filtersets.py
git add netbox_circuitmaintenance/forms.py
git commit -m "refactor: improve filtersets with better search, fix filter form widgets"
```

---

### Task 11: Add SearchIndex for global search

**Files:**
- Create: `netbox_circuitmaintenance/search.py`
- Modify: `netbox_circuitmaintenance/__init__.py`

**Step 1: Create search.py**

```python
from netbox.search import SearchIndex, register_search

from .models import CircuitMaintenance, CircuitMaintenanceNotifications


@register_search
class CircuitMaintenanceIndex(SearchIndex):
    model = CircuitMaintenance
    fields = (
        ('name', 100),
        ('summary', 500),
        ('internal_ticket', 1000),
        ('comments', 5000),
    )


@register_search
class CircuitMaintenanceNotificationsIndex(SearchIndex):
    model = CircuitMaintenanceNotifications
    fields = (
        ('subject', 100),
        ('email_from', 1000),
    )
```

The weights (second element) control relevance ranking. Lower = higher priority.

**Step 2: No changes needed to __init__.py**

NetBox auto-discovers `search.py` in plugin packages via `@register_search`.

**Step 3: Commit**

```bash
git add netbox_circuitmaintenance/search.py
git commit -m "feat: add SearchIndex for global search support"
```

---

### Task 12: Add GraphQL types

**Files:**
- Create: `netbox_circuitmaintenance/graphql/__init__.py`
- Create: `netbox_circuitmaintenance/graphql/types.py`

**Step 1: Create graphql/__init__.py (empty)**

```python
```

**Step 2: Create graphql/types.py**

```python
import strawberry
import strawberry_django

from netbox.graphql.types import NetBoxObjectType

from ..models import (
    CircuitMaintenance,
    CircuitMaintenanceImpact,
    CircuitMaintenanceNotifications,
)
from .. import filtersets


@strawberry_django.type(CircuitMaintenance, fields='__all__')
class CircuitMaintenanceType(NetBoxObjectType):

    @strawberry_django.field
    def provider(self) -> str:
        return str(self.provider)


@strawberry_django.type(CircuitMaintenanceImpact, fields='__all__')
class CircuitMaintenanceImpactType(NetBoxObjectType):
    pass


@strawberry_django.type(CircuitMaintenanceNotifications, fields='__all__')
class CircuitMaintenanceNotificationType(NetBoxObjectType):
    pass
```

**Step 3: Create graphql/schema.py**

```python
import strawberry

from .types import (
    CircuitMaintenanceType,
    CircuitMaintenanceImpactType,
    CircuitMaintenanceNotificationType,
)

schema = [
    CircuitMaintenanceType,
    CircuitMaintenanceImpactType,
    CircuitMaintenanceNotificationType,
]
```

**Step 4: Register GraphQL schema in __init__.py**

Add `graphql_schema` attribute to `CircuitMaintenanceConfig`:

```python
class CircuitMaintenanceConfig(PluginConfig):
    name = 'netbox_circuitmaintenance'
    verbose_name = 'Netbox Circuit Maintenance Plugin'
    description = 'Manages circuit maintenance events'
    version = __version__
    base_url = 'maintenance'
    graphql_schema = 'netbox_circuitmaintenance.graphql.schema.schema'

    def ready(self):
        super().ready()
        from . import widgets
```

**Step 5: Run linting**

Run: `make format && make lint`

**Step 6: Commit**

```bash
git add netbox_circuitmaintenance/graphql/__init__.py
git add netbox_circuitmaintenance/graphql/types.py
git add netbox_circuitmaintenance/graphql/schema.py
git add netbox_circuitmaintenance/__init__.py
git commit -m "feat: add GraphQL type definitions (closes #7)"
```

---

### Task 13: Filter circuit dropdown by provider in impact form

**Files:**
- Modify: `netbox_circuitmaintenance/forms.py:65-73`

**Step 1: Add query_params to the circuit DynamicModelChoiceField**

```python
class CircuitMaintenanceImpactForm(NetBoxModelForm):

    circuit = DynamicModelChoiceField(
        queryset=Circuit.objects.all(),
        query_params={
            'provider_id': '$circuitmaintenance',
        }
    )

    class Meta:
        model = CircuitMaintenanceImpact
        fields = ('circuitmaintenance', 'circuit', 'impact')
```

This tells NetBox's dynamic field JS to re-query the circuit API endpoint filtered by the selected maintenance's provider whenever the `circuitmaintenance` field changes. However, the circuit API filters by `provider_id` while we're passing a `circuitmaintenance` ID.

A better approach is to make `circuitmaintenance` a `DynamicModelChoiceField` too, and chain the provider through it:

```python
from utilities.forms.fields import DynamicModelChoiceField, DynamicModelMultipleChoiceField

class CircuitMaintenanceImpactForm(NetBoxModelForm):

    circuitmaintenance = DynamicModelChoiceField(
        queryset=CircuitMaintenance.objects.all(),
    )

    circuit = DynamicModelChoiceField(
        queryset=Circuit.objects.all(),
        query_params={
            'provider_id': '$circuitmaintenance__provider',
        }
    )

    class Meta:
        model = CircuitMaintenanceImpact
        fields = ('circuitmaintenance', 'circuit', 'impact')
```

Note: The `$circuitmaintenance__provider` syntax depends on how the form passes the related provider. If this doesn't work with NetBox's dynamic fields, an alternative is to add a hidden `provider` field populated via JavaScript, or override the form's `__init__` to filter the queryset server-side when editing. Test this interactively against a running NetBox instance.

**Step 2: Run linting**

Run: `make format && make lint`

**Step 3: Commit**

```bash
git add netbox_circuitmaintenance/forms.py
git commit -m "feat: filter circuit dropdown by maintenance provider (closes #12)"
```

---

## Phase 3: Calendar Improvements & Features

### Task 14: Replace inline calendar dimensions with CSS

**Files:**
- Modify: `netbox_circuitmaintenance/views.py:190`
- Modify: `netbox_circuitmaintenance/widgets.py:42`
- Modify: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar.html`
- Modify: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar_widget.html`

**Step 1: Remove string replacement hacks from views.py and widgets.py**

In `views.py`, remove line 190:
```python
# DELETE this line:
html_calendar = html_calendar.replace('<td ', '<td  width="300" height="150"')
```

In `widgets.py`, remove line 42:
```python
# DELETE this line:
html_calendar = html_calendar.replace('<td ', '<td  width="100" height="100"')
```

**Step 2: Add responsive CSS to calendar.html**

Replace the `<style>` block in `calendar.html`:

```html
{% block content %}
<style>
.table td {
    min-width: 140px;
    height: 150px;
    vertical-align: top;
    padding: 4px 8px;
}
.table td ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.table td .badge {
    display: inline-block;
    margin-bottom: 4px;
    white-space: normal;
    text-align: left;
}
.table td .badge a {
    color: inherit;
    text-decoration: none;
}
.today-highlight {
    background-color: rgba(var(--bs-primary-rgb), 0.1) !important;
    border-left: 3px solid var(--bs-primary) !important;
}
@media (max-width: 992px) {
    .table td {
        min-width: 100px;
        height: auto;
        font-size: 0.85rem;
    }
}
@media (max-width: 576px) {
    .table td {
        min-width: 60px;
        padding: 2px 4px;
    }
    .table td .badge {
        font-size: 0.7rem;
    }
}
</style>
{{ calendar }}
{% endblock content %}
```

**Step 3: Add CSS to calendar_widget.html**

```html
{% load helpers %}
<style>
.maintenance-calendar td {
    min-width: 60px;
    height: 80px;
    vertical-align: top;
    padding: 2px 4px;
    font-size: 0.8rem;
}
.maintenance-calendar td ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.maintenance-calendar td .badge {
    display: inline-block;
    font-size: 0.7rem;
    margin-bottom: 2px;
    white-space: normal;
}
.maintenance-calendar td .badge a {
    color: inherit;
    text-decoration: none;
}
.maintenance-calendar .today-highlight {
    background-color: rgba(var(--bs-primary-rgb), 0.1) !important;
}
</style>
<div class="maintenance-calendar">
{{ calendar }}
</div>
<div class="text-end mt-2">
    <a href="{% url 'plugins:netbox_circuitmaintenance:maintenanceschedule' %}" class="btn btn-sm btn-outline-primary">
        View Full Calendar
    </a>
</div>
```

**Step 4: Update formatmonth to add a CSS class to the table**

In `views.py`, in the `Calendar.formatmonth()` method, change:
```python
a('<table class="table">')
```
to:
```python
a('<table class="table table-bordered">')
```

**Step 5: Run linting**

Run: `make format && make lint`

**Step 6: Commit**

```bash
git add netbox_circuitmaintenance/views.py
git add netbox_circuitmaintenance/widgets.py
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar.html
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar_widget.html
git commit -m "feat: responsive calendar CSS, remove inline dimensions, link widget to full calendar"
```

---

### Task 15: Add htmx month navigation to calendar

**Files:**
- Modify: `netbox_circuitmaintenance/views.py` (CircuitMaintenanceScheduleView)
- Modify: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar.html`
- Create: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar_partial.html`

**Step 1: Create a partial template for just the calendar content**

Create `calendar_partial.html`:

```html
<div id="calendar-content">
{{ calendar }}
</div>
```

**Step 2: Update calendar.html to use htmx**

```html
{% extends 'generic/_base.html' %}
{% load buttons %}
{% load static %}
{% load helpers %}

{% block title %}Circuit Maintenance Schedule{% endblock %}

{% block controls %}
  <div class="controls">
    <div class="control-group">
        <a class="btn btn-outline-secondary"
           hx-get="{% url 'plugins:netbox_circuitmaintenance:maintenanceschedule' %}?month={{ prev_month }}&year={{ prev_year }}"
           hx-target="#calendar-container"
           hx-swap="innerHTML"
           hx-push-url="true">
            <i class="mdi mdi-arrow-left"></i> Previous Month
        </a>
        {% if month != this_month or year != this_year %}
        <a class="btn btn-outline-secondary"
           hx-get="{% url 'plugins:netbox_circuitmaintenance:maintenanceschedule' %}?month={{ this_month }}&year={{ this_year }}"
           hx-target="#calendar-container"
           hx-swap="innerHTML"
           hx-push-url="true">
            Today
        </a>
        {% endif %}
        <a class="btn btn-outline-secondary"
           hx-get="{% url 'plugins:netbox_circuitmaintenance:maintenanceschedule' %}?month={{ next_month }}&year={{ next_year }}"
           hx-target="#calendar-container"
           hx-swap="innerHTML"
           hx-push-url="true">
            Next Month <i class="mdi mdi-arrow-right"></i>
        </a>
    </div>
  </div>
{% endblock controls %}

{% block content %}
<style>
.table td {
    min-width: 140px;
    height: 150px;
    vertical-align: top;
    padding: 4px 8px;
}
.table td ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.table td .badge {
    display: inline-block;
    margin-bottom: 4px;
    white-space: normal;
    text-align: left;
}
.table td .badge a {
    color: inherit;
    text-decoration: none;
}
.today-highlight {
    background-color: rgba(var(--bs-primary-rgb), 0.1) !important;
    border-left: 3px solid var(--bs-primary) !important;
}
@media (max-width: 992px) {
    .table td {
        min-width: 100px;
        height: auto;
        font-size: 0.85rem;
    }
}
@media (max-width: 576px) {
    .table td {
        min-width: 60px;
        padding: 2px 4px;
    }
    .table td .badge {
        font-size: 0.7rem;
    }
}
</style>
<div id="calendar-container">
{% include 'netbox_circuitmaintenance/calendar_partial.html' %}
</div>
{% endblock content %}
```

**Step 3: Update the view to detect htmx requests**

In `CircuitMaintenanceScheduleView.get()`, return the partial template for htmx requests:

```python
class CircuitMaintenanceScheduleView(PermissionRequiredMixin, View):
    permission_required = 'netbox_circuitmaintenance.view_circuitmaintenance'
    template_name = 'netbox_circuitmaintenance/calendar.html'
    partial_template_name = 'netbox_circuitmaintenance/calendar_partial.html'

    def get(self, request):
        curr_month = datetime.date.today()

        if request.GET.get('month'):
            month = int(request.GET["month"])
            year = int(request.GET["year"])
        else:
            month = curr_month.month
            year = curr_month.year

        cal = Calendar(year, month)
        html_calendar = cal.formatmonth(year, month)

        context = {
            "calendar": mark_safe(html_calendar),
            "this_month": curr_month.month,
            "this_year": curr_month.year,
            "month": month,
            "year": year,
            "next_month": cal.next_month(month),
            "next_year": cal.next_year(month, year),
            "prev_month": cal.prev_month(month),
            "prev_year": cal.prev_year(month, year),
        }

        # Return partial for htmx requests
        template = self.partial_template_name if request.headers.get('HX-Request') else self.template_name
        return render(request, template, context)
```

**Step 4: Run linting**

Run: `make format && make lint`

**Step 5: Commit**

```bash
git add netbox_circuitmaintenance/views.py
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar.html
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar_partial.html
git commit -m "feat: add htmx-powered month navigation to calendar"
```

---

### Task 16: Add ICS/iCal feed endpoint

**Files:**
- Modify: `pyproject.toml` (add icalendar dependency)
- Create: `netbox_circuitmaintenance/ical.py`
- Modify: `netbox_circuitmaintenance/urls.py`
- Modify: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar.html` (add subscribe link)

**Step 1: Add icalendar dependency to pyproject.toml**

```toml
dependencies = [
    "nh3>=0.2.14",
    "icalendar>=5.0.0",
]
```

**Step 2: Create ical.py**

```python
import datetime

from django.http import HttpResponse
from django.views import View
from icalendar import Calendar, Event, vText

from .constants import ACTIVE_STATUSES
from .models import CircuitMaintenance


class MaintenanceICalView(View):
    """Generate an ICS feed of maintenance events."""

    def get(self, request):
        cal = Calendar()
        cal.add('prodid', '-//NetBox Circuit Maintenance//EN')
        cal.add('version', '2.0')
        cal.add('calscale', 'GREGORIAN')
        cal.add('method', 'PUBLISH')
        cal.add('x-wr-calname', 'Circuit Maintenance')

        # Include active + recent completed (last 30 days)
        cutoff = datetime.datetime.now(tz=datetime.timezone.utc) - datetime.timedelta(days=30)
        maintenances = CircuitMaintenance.objects.filter(
            end__gte=cutoff
        ).select_related('provider').prefetch_related('impact')

        for maint in maintenances:
            event = Event()
            event.add('uid', f'maintenance-{maint.pk}@netbox')
            event.add('dtstart', maint.start)
            event.add('dtend', maint.end)
            event.add('summary', f'[{maint.status}] {maint.provider} - {maint.name}')
            event.add('description', maint.summary)
            event.add('status', 'CONFIRMED' if maint.status == 'CONFIRMED' else 'TENTATIVE')

            impact_count = maint.impact.count()
            if impact_count:
                circuits = ', '.join(
                    str(i.circuit) for i in maint.impact.all()
                )
                event.add('description', f'{maint.summary}\n\nImpacted circuits ({impact_count}): {circuits}')

            event['organizer'] = vText(str(maint.provider))
            cal.add_component(event)

        response = HttpResponse(
            cal.to_ical(),
            content_type='text/calendar; charset=utf-8',
        )
        response['Content-Disposition'] = 'attachment; filename="circuit-maintenance.ics"'
        return response
```

**Step 3: Add URL route**

In `urls.py`, add the import and route:

```python
from .ical import MaintenanceICalView
```

Add to urlpatterns:
```python
path('maintenance.ics', MaintenanceICalView.as_view(), name='maintenance_ics'),
```

**Step 4: Add subscribe link to calendar.html**

In the `{% block controls %}` section, after the navigation buttons, add:

```html
<div class="control-group">
    <a class="btn btn-outline-success" href="{% url 'plugins:netbox_circuitmaintenance:maintenance_ics' %}" title="Subscribe to ICS feed">
        <i class="mdi mdi-calendar-export"></i> Subscribe (ICS)
    </a>
</div>
```

**Step 5: Add to navigation.py**

Add the ICS feed as a menu item in `navigation.py`:

```python
PluginMenuItem(
    link='plugins:netbox_circuitmaintenance:maintenance_ics',
    link_text='ICS Feed',
),
```

**Step 6: Run linting**

Run: `make format && make lint`

**Step 7: Commit**

```bash
git add pyproject.toml
git add netbox_circuitmaintenance/ical.py
git add netbox_circuitmaintenance/urls.py
git add netbox_circuitmaintenance/navigation.py
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/calendar.html
git commit -m "feat: add ICS/iCal subscription feed (closes #14)"
```

---

### Task 17: Add historical maintenance tab to template extensions

**Files:**
- Modify: `netbox_circuitmaintenance/template_content.py`
- Create: `netbox_circuitmaintenance/templates/netbox_circuitmaintenance/maintenance_tabs_include.html`

**Step 1: Create combined tab template**

Create `maintenance_tabs_include.html`:

```html
{% load helpers %}

<div class="card">
    <h5 class="card-header">Circuit Maintenance</h5>
    <div class="card-body p-0">
        <ul class="nav nav-tabs px-3 pt-2" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#active-maintenance" type="button" role="tab">
                    Active / Upcoming
                    {% if active_maintenance %}
                        <span class="badge text-bg-warning ms-1">{{ active_maintenance|length }}</span>
                    {% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#historical-maintenance" type="button" role="tab">
                    Historical
                    {% if historical_maintenance %}
                        <span class="badge text-bg-secondary ms-1">{{ historical_maintenance|length }}</span>
                    {% endif %}
                </button>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="active-maintenance" role="tabpanel">
                {% if active_maintenance %}
                <div class="table-responsive">
                    <table class="table table-hover object-list mb-0">
                        <thead>
                        <tr>
                            <th>Maintenance ID</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Status</th>
                            <th>Impact</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for maintenance in active_maintenance %}
                        <tr>
                            <td>{{ maintenance.circuitmaintenance|linkify }}</td>
                            <td>{{ maintenance.circuitmaintenance.start }}</td>
                            <td>{{ maintenance.circuitmaintenance.end }}</td>
                            <td>{% badge maintenance.circuitmaintenance.get_status_display bg_color=maintenance.circuitmaintenance.get_status_color %}</td>
                            <td>{% badge maintenance.get_impact_display bg_color=maintenance.get_impact_color %}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted p-3">None</div>
                {% endif %}
            </div>
            <div class="tab-pane fade" id="historical-maintenance" role="tabpanel">
                {% if historical_maintenance %}
                <div class="table-responsive">
                    <table class="table table-hover object-list mb-0">
                        <thead>
                        <tr>
                            <th>Maintenance ID</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Status</th>
                            <th>Impact</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for maintenance in historical_maintenance %}
                        <tr>
                            <td>{{ maintenance.circuitmaintenance|linkify }}</td>
                            <td>{{ maintenance.circuitmaintenance.start }}</td>
                            <td>{{ maintenance.circuitmaintenance.end }}</td>
                            <td>{% badge maintenance.circuitmaintenance.get_status_display bg_color=maintenance.circuitmaintenance.get_status_color %}</td>
                            <td>{% badge maintenance.get_impact_display bg_color=maintenance.get_impact_color %}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted p-3">None</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
```

**Step 2: Update template_content.py**

Rewrite to provide both active and historical context:

```python
from netbox.plugins import PluginTemplateExtension
from django.db.models import Q
from .models import CircuitMaintenanceImpact
from .constants import ACTIVE_STATUSES

TERMINAL_STATUSES = ('COMPLETED', 'CANCELLED')


class CircuitMaintenanceList(PluginTemplateExtension):
    models = ('circuits.circuit',)

    def left_page(self):
        circuit = self.context['object']
        base_qs = CircuitMaintenanceImpact.objects.filter(circuit=circuit)
        return self.render('netbox_circuitmaintenance/maintenance_tabs_include.html', extra_context={
            'active_maintenance': base_qs.filter(circuitmaintenance__status__in=ACTIVE_STATUSES),
            'historical_maintenance': base_qs.filter(circuitmaintenance__status__in=TERMINAL_STATUSES).order_by('-circuitmaintenance__end')[:20],
        })


class ProviderMaintenanceList(PluginTemplateExtension):
    models = ('circuits.provider',)

    def left_page(self):
        provider = self.context['object']
        base_qs = CircuitMaintenanceImpact.objects.filter(circuitmaintenance__provider=provider)
        return self.render('netbox_circuitmaintenance/maintenance_tabs_include.html', extra_context={
            'active_maintenance': base_qs.filter(circuitmaintenance__status__in=ACTIVE_STATUSES),
            'historical_maintenance': base_qs.filter(circuitmaintenance__status__in=TERMINAL_STATUSES).order_by('-circuitmaintenance__end')[:20],
        })


class SiteMaintenanceList(PluginTemplateExtension):
    models = ('dcim.site',)

    def left_page(self):
        site = self.context['object']
        site_q = Q(circuit__termination_a___site=site) | Q(circuit__termination_z___site=site)
        base_qs = CircuitMaintenanceImpact.objects.filter(site_q)
        return self.render('netbox_circuitmaintenance/maintenance_tabs_include.html', extra_context={
            'active_maintenance': base_qs.filter(circuitmaintenance__status__in=ACTIVE_STATUSES),
            'historical_maintenance': base_qs.filter(circuitmaintenance__status__in=TERMINAL_STATUSES).order_by('-circuitmaintenance__end')[:20],
        })


template_extensions = [CircuitMaintenanceList, ProviderMaintenanceList, SiteMaintenanceList]
```

Note: The old templates `circuitmaintenance_include.html` and `providermaintenance_include.html` are replaced by `maintenance_tabs_include.html`. Keep the old files for now (they may be referenced elsewhere) but they are no longer used by template_content.py.

**Step 3: Run linting**

Run: `make format && make lint`

**Step 4: Commit**

```bash
git add netbox_circuitmaintenance/template_content.py
git add netbox_circuitmaintenance/templates/netbox_circuitmaintenance/maintenance_tabs_include.html
git commit -m "feat: add historical maintenance tab on Circuit/Provider/Site pages (closes #3)"
```

---

### Task 18: Update version and changelog

**Files:**
- Modify: `netbox_circuitmaintenance/__init__.py:5`
- Modify: `CHANGELOG.md`

**Step 1: Update version string**

```python
__version__ = '0.7.0'
```

**Step 2: Update CHANGELOG.md**

Add a new section at the top of the changelog:

```markdown
## v0.7.0

### Breaking Changes
- API field `email_recieved` renamed to `email_received` (typo fix)
- API serializers restructured: removed separate nested serializer classes, added `brief_fields`

### Bug Fixes
- Fixed XSS vulnerability in notification email display (now sanitised with nh3)
- Fixed DEGRADED impact badge color (`orage` → `orange`)
- Fixed calendar year navigation (prev/next were both broken)
- Fixed calendar not showing events spanning month boundaries
- Fixed broken search in CircuitMaintenanceImpact filterset
- Fixed malformed HTML and Bootstrap 5 attributes in summary table column
- Fixed verbose_name typo (`Imapct` → `Impact`)
- Removed invalid `max_length` parameter from DateTimeFields
- Removed unnecessary `null=True` from `acknowledged` BooleanField

### Enhancements
- Added `clone_fields` for better clone functionality (#13)
- Added date range validation (end must be after start)
- Added unique constraint preventing duplicate circuit/maintenance associations
- Added SearchIndex for global search support
- Added GraphQL type definitions (#7)
- Added ICS/iCal subscription feed (#14)
- Added historical maintenance tab on Circuit, Provider, and Site pages (#3)
- Added responsive CSS for calendar views
- Added htmx-powered calendar month navigation (no page reload)
- Added "View Full Calendar" link on dashboard widget
- Circuit dropdown in impact form now filtered by maintenance provider (#12)
- Filter form date fields now use DateTimePicker widgets
- Expanded search to include summary, provider name, and internal ticket
- Centralised active status constants (DRY)

### Dependencies
- Added `nh3>=0.2.14` (HTML sanitisation)
- Added `icalendar>=5.0.0` (ICS feed generation)
```

**Step 3: Update pyproject.toml version**

```toml
version = "0.7.0"
```

Also update `[tool.bumpver]`:
```toml
current_version = "0.7.0"
```

**Step 4: Commit**

```bash
git add netbox_circuitmaintenance/__init__.py
git add CHANGELOG.md
git add pyproject.toml
git commit -m "release: v0.7.0"
```

---

## Verification Checklist

After all tasks are complete, verify against a running NetBox 4.4 instance:

- [ ] Plugin loads without errors
- [ ] Migrations apply cleanly (`python manage.py migrate`)
- [ ] Global search returns maintenance records
- [ ] Calendar navigates months correctly (especially Dec→Jan, Jan→Dec)
- [ ] Calendar shows events spanning multiple days/months
- [ ] htmx calendar navigation works without page reload
- [ ] ICS feed downloads valid `.ics` file
- [ ] ICS feed subscribes correctly in a calendar app
- [ ] Notification email body renders without raw HTML/scripts
- [ ] Circuit dropdown in impact form filters by provider
- [ ] Clone button pre-populates fields
- [ ] Cannot set end date before start date
- [ ] Cannot add same circuit to same maintenance twice
- [ ] Historical tab shows completed/cancelled maintenance on Circuit/Provider/Site pages
- [ ] GraphQL queries return maintenance data
- [ ] API brief mode returns only `brief_fields`
- [ ] `make lint` passes
- [ ] `make format` makes no changes

---

## Issues Closed by This Release

- #3 — Historical maintenance tabs
- #7 — GraphQL support
- #12 — Filter circuit choices by provider
- #13 — Better clone functionality
- #14 — Calendar views (ICS feed)

## Issues Recommended to Close

- #6 — Already documented (automatic updates via parsers)
